// =========================
// MATRIX MARKETPLACE MAIN.JS (Global Online Control)
// =========================

// -------------------------
// Backend API base
// -------------------------
const API_BASE = "https://your-live-domain.com/api"; // live API URL
let socket;

// -------------------------
// Authentication helpers
// -------------------------
async function requireAuth(role) {
    const token = sessionStorage.getItem("mm_token"); // token only stored temporarily
    if (!token) return window.location.href = "login.html";

    const res = await fetch(`${API_BASE}/auth/me`, { headers: { 'Authorization': 'Bearer ' + token } });
    if (!res.ok) return window.location.href = "login.html";

    const data = await res.json();
    if (role && data.role !== role) {
        alert("Unauthorized access");
        return window.location.href = "index.html";
    }
    return data;
}

// -------------------------
// Generic API request
// -------------------------
async function apiRequest(endpoint, method = "GET", body) {
    const token = sessionStorage.getItem("mm_token");
    const res = await fetch(API_BASE + endpoint, {
        method,
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
        },
        body: body ? JSON.stringify(body) : undefined
    });
    if (!res.ok) {
        const err = await res.json().catch(() => ({ message: 'API Error' }));
        throw new Error(err.message);
    }
    return res.json();
}

// -------------------------
// Alert helper
// -------------------------
function showAlert(msg, type = "info") {
    alert(`${type.toUpperCase()}: ${msg}`);
}

// -------------------------
// Format currency
// -------------------------
function formatCurrency(amount) {
    return new Intl.NumberFormat('en-GM', { style: 'currency', currency: 'GMD' }).format(amount);
}

// -------------------------
// Initialize WebSocket for live updates
// -------------------------
function initSocket() {
    if (!window.io) return;
    socket = io(API_BASE.replace('/api', ''), { auth: { token: sessionStorage.getItem("mm_token") } });

    socket.on("paymentUpdate", loadAdminPayments);
    socket.on("sellerUpdate", loadAdminSellers);
    socket.on("userUpdate", loadAdminUsers);
    socket.on("cartUpdate", loadCart); // update buyer carts globally
}

// -------------------------
// Page detection
// -------------------------
document.addEventListener("DOMContentLoaded", () => {
    initSocket();
    const page = document.body.dataset.page;

    switch(page) {
        case "index": loadShop(); break;
        case "dashboard-admin": loadAdminDashboard(); break;
        case "admin-users": loadAdminUsers(); break;
        case "admin-sellers": loadAdminSellers(); break;
        case "admin-edit-user-seller": loadAdminEditUsersSellers(); break;
        case "admin-accept-payment":
        case "payment-accept-decline-users": loadAdminPayments(); break;
        case "seller-dashboard": loadSellerDashboard(); break;
        case "seller-product": loadSellerProducts(); break;
        case "cart": loadCart(); break;
        case "checkout": loadCheckout(); break;
        case "confirm-payment": loadConfirmPayment(); break;
        case "payment-status-sellers": loadSellerPayments(); break;
        case "shop": loadShop(); break;
        case "chat": initChat(); break;
        case "buyers-orders": loadBuyerOrders(); break;
        case "subscription": loadSubscriptions(); break;
        case "setting": loadSettings(); break;
    }
});

// -------------------------
// SHOP
// -------------------------
async function loadShop() {
    await requireAuth();
    const container = document.getElementById("product-list");
    if (!container) return;

    const products = await apiRequest("/products");
    container.innerHTML = products.map(p => `
        <div class="product-card">
            <img src="${p.image}" alt="${p.title}">
            <h3>${p.title}</h3>
            <p>${formatCurrency(p.price)}</p>
            <button onclick="addToCart('${p._id}')">Add to Cart</button>
        </div>
    `).join('');
}

async function addToCart(productId) {
    try {
        await apiRequest("/cart/add", "POST", { productId });
        showAlert("Product added to cart!", "success");
        socket.emit("cartChanged"); // notify server for global updates
    } catch (e) {
        showAlert(e.message, "error");
    }
}

// -------------------------
// CART
// -------------------------
async function loadCart() {
    await requireAuth();
    const container = document.getElementById("cartItems");
    if (!container) return;

    const cart = await apiRequest("/cart");
    container.innerHTML = cart.items.map(item => `
        <div>
            ${item.product.title} - ${formatCurrency(item.product.price)}
            <button onclick="removeFromCart('${item.product._id}')">Remove</button>
        </div>
    `).join('');
}

async function removeFromCart(productId) {
    await apiRequest("/cart/remove", "POST", { productId });
    showAlert("Removed from cart", "success");
    socket.emit("cartChanged");
}

// -------------------------
// ADMIN DASHBOARD
// -------------------------
async function loadAdminDashboard() {
    await requireAuth("admin");
    const overview = await apiRequest("/admin/overview");

    document.getElementById("totalUsers").textContent = overview.usersCount;
    document.getElementById("totalSellers").textContent = overview.sellersCount;
    document.getElementById("totalProducts").textContent = overview.productsCount;

    renderRecentTable("recentSellers", overview.recentSellers, "Seller");
    renderRecentTable("recentUsers", overview.recentUsers, "User");
}

// -------------------------
// ADMIN USERS / SELLERS / PAYMENTS
// -------------------------
async function loadAdminUsers() {
    await requireAuth("admin");
    const users = await apiRequest("/admin/users");
    const table = document.getElementById("usersTable");
    if (!table) return;
    table.innerHTML = `<tr><th>Name</th><th>Email</th><th>Role</th><th>Action</th></tr>`;
    users.forEach(u => {
        table.innerHTML += `<tr>
            <td>${u.name}</td>
            <td>${u.email}</td>
            <td>${u.role}</td>
            <td>
                <button onclick="updateUserRole('${u._id}','admin')">Admin</button>
                <button onclick="updateUserRole('${u._id}','buyer')">Buyer</button>
                <button onclick="updateUserRole('${u._id}','seller')">Seller</button>
            </td>
        </tr>`;
    });
}

async function updateUserRole(id, role) {
    await apiRequest(`/admin/user/${id}/role`, "PUT", { role });
    showAlert("Role updated!", "success");
    socket.emit("userChanged");
}

async function loadAdminSellers() {
    await requireAuth("admin");
    const sellers = await apiRequest("/admin/sellers");
    const table = document.getElementById("sellerTable");
    if (!table) return;
    table.innerHTML = `<tr><th>Name</th><th>Email</th><th>Status</th><th>Action</th></tr>`;
    sellers.forEach(s => {
        table.innerHTML += `<tr>
            <td>${s.name}</td>
            <td>${s.email}</td>
            <td>${s.status}</td>
            <td>
                <button onclick="updateSellerStatus('${s._id}','Approved')">Approve</button>
                <button onclick="updateSellerStatus('${s._id}','Declined')">Decline</button>
            </td>
        </tr>`;
    });
}

async function updateSellerStatus(id, status) {
    await apiRequest(`/admin/seller/${id}/status`, "PUT", { status });
    showAlert("Seller status updated!", "success");
    socket.emit("sellerChanged");
}

async function loadAdminPayments() {
    await requireAuth("admin");
    const payments = await apiRequest("/admin/payments");
    const table = document.getElementById("paymentBody");
    if (!table) return;
    table.innerHTML = "";
    payments.forEach(p => {
        table.innerHTML += `<tr>
            <td>${p.name}</td>
            <td>${p.email}</td>
            <td>${formatCurrency(p.amount)}</td>
            <td>${p.method}</td>
            <td>${new Date(p.date).toLocaleString()}</td>
            <td>${p.status}</td>
            <td>
                ${p.status === "Pending" 
                    ? `<button onclick="updatePayment('${p._id}','Approved')">Accept</button>
                       <button onclick="updatePayment('${p._id}','Declined')">Decline</button>` 
                    : "-"}
            </td>
        </tr>`;
    });
}

async function updatePayment(id, status) {
    await apiRequest(`/admin/payment/${id}/status`, "PUT", { status });
    showAlert("Payment updated!", "success");
    socket.emit("paymentChanged");
}

// -------------------------
// SELLER DASHBOARD
// -------------------------
async function loadSellerDashboard() {
    await requireAuth("seller");
    const products = await apiRequest("/products/seller/me");
    renderSellerProducts(products);
}

function renderSellerProducts(products) {
    const table = document.getElementById("sellerProductTable");
    if (!table) return;
    table.innerHTML = `<tr><th>Title</th><th>Price</th><th>Status</th></tr>`;
    products.forEach(p => {
        table.innerHTML += `<tr>
            <td>${p.title}</td>
            <td>${formatCurrency(p.price)}</td>
            <td>${p.status}</td>
        </tr>`;
    });
}

async function loadSellerPayments() {
    await requireAuth("seller");
    const payments = await apiRequest("/seller/payments");
    const table = document.getElementById("paymentBody");
    if (!table) return;
    table.innerHTML = "";
    payments.forEach(p => {
        table.innerHTML += `<tr>
            <td>${p.name}</td>
            <td>${formatCurrency(p.amount)}</td>
            <td>${p.status}</td>
        </tr>`;
    });
}

// -------------------------
// ORDERS / CHAT / SETTINGS / SUBSCRIPTIONS
// -------------------------
async function loadBuyerOrders() {
    await requireAuth();
    const orders = await apiRequest("/orders");
    const table = document.getElementById("ordersTable");
    if (!table) return;
    table.innerHTML = `<tr><th>Order ID</th><th>Status</th><th>Total</th></tr>`;
    orders.forEach(o => {
        table.innerHTML += `<tr>
            <td>${o._id}</td>
            <td>${o.status}</td>
            <td>${formatCurrency(o.total)}</td>
        </tr>`;
    });
}

function initChat() { console.log("Chat initialized (Socket.io required)"); }
async function loadSubscriptions() { await requireAuth(); console.log("Load subscriptions"); }
async function loadSettings() { await requireAuth(); console.log("Load settings"); }
