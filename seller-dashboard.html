// =========================
// MATRIX MARKETPLACE MAIN.JS (Updated for Live Real-Time Control)
// =========================

// -------------------------
// Backend API base
// -------------------------
const API_BASE = "http://localhost:4000/api"; // change to live URL when online
let socket;

// -------------------------
// Authentication helpers
// -------------------------
function getToken() {
    return localStorage.getItem("mm_token");
}

async function requireAuth(role) {
    const token = getToken();
    if (!token) return window.location.href = "login.html";

    const res = await fetch(`${API_BASE}/auth/me`, { headers: { 'Authorization': 'Bearer ' + token } });
    if (!res.ok) return window.location.href = "login.html";

    const data = await res.json();
    if (role && data.role !== role) {
        alert("Unauthorized access");
        return window.location.href = "index.html";
    }
    return data;
}

// -------------------------
// Generic API request
// -------------------------
async function apiRequest(endpoint, method = "GET", body) {
    const token = getToken();
    const res = await fetch(API_BASE + endpoint, {
        method,
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
        },
        body: body ? JSON.stringify(body) : undefined
    });
    if (!res.ok) throw new Error((await res.json()).message || 'API Error');
    return res.json();
}

// -------------------------
// Alert helper
// -------------------------
function showAlert(msg, type = "info") {
    // optionally can integrate SweetAlert or Toast for nicer UI
    alert(`${type.toUpperCase()}: ${msg}`);
}

// -------------------------
// Format currency
// -------------------------
function formatCurrency(amount) {
    return new Intl.NumberFormat('en-GM', { style: 'currency', currency: 'GMD' }).format(amount);
}

// -------------------------
// Initialize WebSocket for live updates
// -------------------------
function initSocket() {
    if (!window.io) return; // make sure Socket.io client is loaded
    socket = io(API_BASE.replace('/api', ''), { auth: { token: getToken() } });

    // Listen for live updates
    socket.on("paymentUpdate", data => {
        const table = document.getElementById("paymentBody");
        if (!table) return;
        loadAdminPayments();
    });

    socket.on("sellerUpdate", data => {
        const table = document.getElementById("sellerTable");
        if (!table) return;
        loadAdminSellers();
    });

    socket.on("userUpdate", data => {
        const table = document.getElementById("usersTable");
        if (!table) return;
        loadAdminUsers();
    });
}

// -------------------------
// Page detection
// -------------------------
document.addEventListener("DOMContentLoaded", () => {
    initSocket();
    const page = document.body.dataset.page;

    switch(page) {
        case "index": loadShop(); break;
        case "dashboard-admin": loadAdminDashboard(); break;
        case "admin-users": loadAdminUsers(); break;
        case "admin-sellers": loadAdminSellers(); break;
        case "admin-edit-user-seller": loadAdminEditUsersSellers(); break;
        case "admin-accept-payment":
        case "payment-accept-decline-users": loadAdminPayments(); break;
        case "seller-dashboard": loadSellerDashboard(); break;
        case "seller-product": loadSellerProducts(); break;
        case "cart": loadCart(); break;
        case "checkout": loadCheckout(); break;
        case "confirm-payment": loadConfirmPayment(); break;
        case "payment-status-sellers": loadSellerPayments(); break;
        case "shop": loadShop(); break;
        case "chat": initChat(); break;
        case "buyers-orders": loadBuyerOrders(); break;
        case "subscription": loadSubscriptions(); break;
        case "setting": loadSettings(); break;
    }
});

// -------------------------
// ADMIN DASHBOARD
// -------------------------
async function loadAdminDashboard() {
    await requireAuth("admin");
    const overview = await apiRequest("/admin/overview");
    document.getElementById("totalUsers").textContent = overview.usersCount;
    document.getElementById("totalSellers").textContent = overview.sellersCount;
    document.getElementById("totalProducts").textContent = overview.productsCount;

    renderRecentTable("recentSellers", overview.recentSellers.slice(-5).reverse(), "Seller");
    renderRecentTable("recentUsers", overview.recentUsers.slice(-5).reverse(), "User");
}

// -------------------------
// Table rendering helper
// -------------------------
function renderRecentTable(tableId, list, type) {
    const table = document.getElementById(tableId);
    if (!table) return;
    table.innerHTML = `<tr><th>${type} Name</th><th>Email</th><th>Status</th><th>Country</th></tr>`;
    list.forEach(item => {
        const statusClass = item.status === "Approved" ? "approved" : item.status === "Declined" ? "declined" : "pending";
        table.innerHTML += `<tr>
            <td>${item.name || "N/A"}</td>
            <td>${item.email || "N/A"}</td>
            <td class="${statusClass}">${item.status || "Pending"}</td>
            <td>${item.country || "Unknown"}</td>
        </tr>`;
    });
}

// -------------------------
// ADMIN USERS
// -------------------------
async function loadAdminUsers() {
    await requireAuth("admin");
    const users = await apiRequest("/admin/users");
    const table = document.getElementById("usersTable");
    if (!table) return;
    table.innerHTML = `<tr><th>Name</th><th>Email</th><th>Role</th><th>Action</th></tr>`;
    users.forEach(u => {
        table.innerHTML += `<tr>
            <td>${u.name}</td>
            <td>${u.email}</td>
            <td>${u.role}</td>
            <td>
                <button onclick="updateUserRole('${u._id}','admin')">Make Admin</button>
                <button onclick="updateUserRole('${u._id}','buyer')">Make Buyer</button>
                <button onclick="updateUserRole('${u._id}','seller')">Make Seller</button>
            </td>
        </tr>`;
    });
}

async function updateUserRole(id, role) {
    await apiRequest(`/admin/user/${id}/role`, "PUT", { role });
    showAlert("Role updated successfully!", "success");
    socket.emit("userChanged", { id, role });
}

// -------------------------
// ADMIN SELLERS
// -------------------------
async function loadAdminSellers() {
    await requireAuth("admin");
    const sellers = await apiRequest("/admin/sellers");
    const table = document.getElementById("sellerTable");
    if (!table) return;
    table.innerHTML = `<tr><th>Name</th><th>Email</th><th>Status</th><th>Action</th></tr>`;
    sellers.forEach(s => {
        const statusClass = s.status === "Approved" ? "approved" : s.status === "Declined" ? "declined" : "pending";
        table.innerHTML += `<tr>
            <td>${s.name}</td><td>${s.email}</td><td class="${statusClass}">${s.status}</td>
            <td>
                <button onclick="updateSellerStatus('${s._id}','Approved')">Approve</button>
                <button onclick="updateSellerStatus('${s._id}','Declined')">Decline</button>
            </td>
        </tr>`;
    });
}

async function updateSellerStatus(id, status) {
    await apiRequest(`/admin/seller/${id}/status`, "PUT", { status });
    showAlert("Seller status updated!", "success");
    socket.emit("sellerChanged", { id, status });
}

// -------------------------
// ADMIN PAYMENTS (Real-Time)
// -------------------------
async function loadAdminPayments() {
    await requireAuth("admin");
    const payments = await apiRequest("/admin/payments");
    const table = document.getElementById("paymentBody");
    if (!table) return;
    table.innerHTML = "";
    payments.forEach(p => {
        const statusClass = p.status.toLowerCase();
        table.innerHTML += `<tr>
            <td>${p.name}</td>
            <td>${p.email}</td>
            <td>${formatCurrency(p.amount)}</td>
            <td>${p.method}</td>
            <td>${new Date(p.date).toLocaleString()}</td>
            <td><span class="status ${statusClass}">${p.status}</span></td>
            <td>
                ${p.status === "Pending"
                    ? `<button onclick="updatePayment('${p._id}','Approved')">Accept</button>
                       <button onclick="updatePayment('${p._id}','Declined')">Decline</button>`
                    : "-"
                }
            </td>
        </tr>`;
    });
}

async function updatePayment(id, status) {
    await apiRequest(`/admin/payment/${id}/status`, "PUT", { status });
    showAlert("Payment status updated!", "success");
    socket.emit("paymentChanged", { id, status });
}

// -------------------------
// SELLER DASHBOARD & PAYMENTS
// -------------------------
async function loadSellerDashboard() {
    await requireAuth("seller");
    const products = await apiRequest(`/products/seller/me`);
    renderSellerProducts(products);
}

function renderSellerProducts(products) {
    const table = document.getElementById("sellerProductTable");
    if (!table) return;
    table.innerHTML = `<tr><th>Title</th><th>Price</th><th>Status</th></tr>`;
    products.forEach(p => {
        table.innerHTML += `<tr>
            <td>${p.title}</td>
            <td>${formatCurrency(p.price)}</td>
            <td>${p.status}</td>
        </tr>`;
    });
}

async function loadSellerPayments() {
    await requireAuth("seller");
    const payments = await apiRequest("/seller/payments");
    const table = document.getElementById("paymentBody");
    if (!table) return;
    table.innerHTML = "";
    payments.forEach(p => {
        table.innerHTML += `<tr>
            <td>${p.name}</td>
            <td>${formatCurrency(p.amount)}</td>
            <td>${p.status}</td>
        </tr>`;
    });
}

// -------------------------
// CART / CHECKOUT
// -------------------------
function loadCart() {
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    const container = document.getElementById("cartItems");
    if (!container) return;
    container.innerHTML = cart.map(id => `<div>Product ID: ${id}</div>`).join('');
}

function loadCheckout() { loadCart(); }
function loadConfirmPayment() { showAlert("Payment confirmed!", "success"); }

// -------------------------
// ORDERS
// -------------------------
async function loadBuyerOrders() {
    await requireAuth();
    const orders = await apiRequest(`/orders`);
    const table = document.getElementById("ordersTable");
    if (!table) return;
    table.innerHTML = `<tr><th>Order ID</th><th>Status</th><th>Total</th></tr>`;
    orders.forEach(o => {
        table.innerHTML += `<tr>
            <td>${o._id}</td>
            <td>${o.status}</td>
            <td>${formatCurrency(o.total)}</td>
        </tr>`;
    });
}

// -------------------------
// CHAT
// -------------------------
function initChat() { console.log("Chat initialized (implement socket.io)"); }

// -------------------------
// SUBSCRIPTIONS / SETTINGS
// -------------------------
async function loadSubscriptions() { await requireAuth(); console.log("Load subscriptions"); }
async function loadSettings() { await requireAuth(); console.log("Load user settings"); }
